<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Transparent Text Display</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: transparent;
      font-family: Arial, sans-serif;
      font-size: 24px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      overflow: hidden;
      -webkit-app-region: drag;
      height: 100vh;
      width: 100vw;
      position: fixed;
      top: 0;
      left: 0;
    }
    
    #text-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      height: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .text-item {
      white-space: pre-wrap;
      word-wrap: break-word;
      transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out;
      opacity: 1;
      transform: translateY(0);
      margin-bottom: 5px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      min-height: 40px;
      display: flex;
      align-items: center;
    }
    
    .slack-message {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      border-radius: 12px;
      border-left: 4px solid #00d4aa;
    }
    
    .slack-avatar {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    
    .slack-content {
      flex: 1;
      min-width: 0;
    }
    
    .slack-user {
      font-size: 14px;
      color: #00d4aa;
      font-weight: 600;
      margin-bottom: 4px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }
    
    .slack-text {
      font-size: 20px;
      color: white;
      line-height: 1.4;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }
    
    .text-item.fade-in {
      opacity: 0;
      transform: translateY(-20px);
    }
    
    .text-item.fade-out {
      opacity: 0;
      transform: translateY(20px);
    }
    
    .text-item.removing {
      transition: all 0.3s ease-in-out;
      opacity: 0;
      transform: translateY(-50px) scale(0.9);
      margin-bottom: -60px;
    }
  </style>
</head>
<body>
  <div id="text-container"></div>
  
  <script>
    const textContainer = document.getElementById('text-container');
    let displayedTexts = [];
    let textIdCounter = 0;
    const maxTexts = 10; // æœ€å¤§è¡¨ç¤ºæ•°
    
    function addDisplayText(text) {
      if (!text.trim()) return;
      
      // æ–°ã—ã„ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’ä½œæˆ
      const textItem = document.createElement('div');
      textItem.className = 'text-item fade-in';
      textItem.textContent = text;
      textItem.id = `text-${++textIdCounter}`;
      
      // ã‚³ãƒ³ãƒ†ãƒŠã®æœ€ä¸Šéƒ¨ã«è¿½åŠ 
      textContainer.insertBefore(textItem, textContainer.firstChild);
      
      // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
      setTimeout(() => {
        textItem.classList.remove('fade-in');
      }, 10);
      
      // é…åˆ—ã«è¿½åŠ 
      displayedTexts.unshift({
        id: textItem.id,
        element: textItem,
        timestamp: Date.now()
      });
      
      // æœ€å¤§æ•°ã‚’è¶…ãˆãŸå ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
      while (displayedTexts.length > maxTexts) {
        removeOldestText();
      }
    }
    
    function removeOldestText() {
      if (displayedTexts.length === 0) return;
      
      const oldest = displayedTexts.pop();
      oldest.element.classList.add('removing');
      
      setTimeout(() => {
        if (oldest.element.parentNode) {
          oldest.element.parentNode.removeChild(oldest.element);
        }
      }, 300);
    }
    
    function clearAllTexts() {
      displayedTexts.forEach(item => {
        item.element.classList.add('fade-out');
        setTimeout(() => {
          if (item.element.parentNode) {
            item.element.parentNode.removeChild(item.element);
          }
        }, 500);
      });
      displayedTexts = [];
      
      // å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆãŒã‚¯ãƒªã‚¢ã•ã‚ŒãŸæ™‚ã«æœ€å‰é¢è¡¨ç¤ºã‚’è§£é™¤
      if (typeof require !== 'undefined') {
        const { ipcRenderer } = require('electron');
        ipcRenderer.send('set-always-on-top', false);
      }
    }
    
    // Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å°‚ç”¨ã®è¡¨ç¤ºé–¢æ•°
    function displaySlackMessage(text, metadata) {
      try {
        // ãƒ†ã‚­ã‚¹ãƒˆã®å®‰å…¨ãªå‡¦ç†
        const safeText = text ? String(text).trim() : '';
        const safeUser = metadata?.user ? String(metadata.user).trim() : 'Unknown';
        const safeUserIcon = metadata?.userIcon || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%23ccc"/><text x="16" y="21" text-anchor="middle" fill="white" font-size="14">ğŸ‘¤</text></svg>';
        
        if (!safeText) {
          console.warn('ç©ºã®Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡:', { text, metadata });
          return;
        }
        
        console.log('Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–‹å§‹:', { text: safeText, user: safeUser });
        
        // æ–°ã—ã„Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’ä½œæˆ
        const messageItem = document.createElement('div');
        messageItem.className = 'text-item slack-message fade-in';
        messageItem.id = `text-${++textIdCounter}`;
        
        // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ
        const avatar = document.createElement('img');
        avatar.className = 'slack-avatar';
        avatar.src = safeUserIcon;
        avatar.onerror = function() {
          this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="16" fill="%23ccc"/><text x="16" y="21" text-anchor="middle" fill="white" font-size="14">ğŸ‘¤</text></svg>';
        };
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢
        const content = document.createElement('div');
        content.className = 'slack-content';
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
        const userDiv = document.createElement('div');
        userDiv.className = 'slack-user';
        userDiv.textContent = safeUser;
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè¤‡æ•°è¡Œå¯¾å¿œï¼‰
        const textDiv = document.createElement('div');
        textDiv.className = 'slack-text';
        // è¤‡æ•°è¡Œãƒ†ã‚­ã‚¹ãƒˆã‚’é©åˆ‡ã«å‡¦ç†
        textDiv.textContent = safeText;
        
        content.appendChild(userDiv);
        content.appendChild(textDiv);
        messageItem.appendChild(avatar);
        messageItem.appendChild(content);
        
        // ã‚³ãƒ³ãƒ†ãƒŠã®æœ€ä¸Šéƒ¨ã«è¿½åŠ 
        textContainer.insertBefore(messageItem, textContainer.firstChild);
        
        console.log('Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’DOMã«è¿½åŠ å®Œäº†');
        
        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        setTimeout(() => {
          messageItem.classList.remove('fade-in');
        }, 10);
        
        // é…åˆ—ã«è¿½åŠ 
        displayedTexts.unshift({
          id: messageItem.id,
          element: messageItem,
          timestamp: Date.now()
        });
        
        // æœ€å¤§æ•°ã‚’è¶…ãˆãŸå ´åˆã¯å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        while (displayedTexts.length > maxTexts) {
          removeOldestText();
        }
        
        console.log('Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå®Œäº†');
        
      } catch (error) {
        console.error('Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', { text, metadata, stack: error.stack });
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: é€šå¸¸ã®ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
        try {
          const fallbackText = `${metadata?.user || 'Unknown'}: ${text || 'ã‚¨ãƒ©ãƒ¼'}`;
          addDisplayText(fallbackText);
        } catch (fallbackError) {
          console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºã‚‚ã‚¨ãƒ©ãƒ¼:', fallbackError);
        }
      }
    }
    
    // å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
    function updateDisplayText(text) {
      if (text === '') {
        clearAllTexts();
      } else {
        addDisplayText(text);
      }
    }
    
    // ãƒ†ã‚¹ãƒˆç”¨ã®åˆæœŸè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    setTimeout(() => {
      clearAllTexts();
    }, 1000);
    
    // IPCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    if (typeof require !== 'undefined') {
      const { ipcRenderer } = require('electron');
      
      // Slackãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
      ipcRenderer.on('display-slack-message-data', (event, data) => {
        const { text, metadata } = data;
        displaySlackMessage(text, metadata);
      });
      
      // é€šå¸¸ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
      ipcRenderer.on('display-text-data', (event, text) => {
        updateDisplayText(text);
      });
    }
  </script>
</body>
</html>